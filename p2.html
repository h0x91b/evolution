<!DOCTYPE html>
<html lang="en">
  <head>
	<title>p2.js and Pixi.js example</title>
	<meta charset="utf-8">
	<script src="deps/pixi.js"></script>
	<script src="deps/decomp.js"></script>
	<script src="deps/p2.js"></script>
	<script src="random.js"></script>
  </head>
  <body>

	<script>
		"use strict"
		var renderer, stage, container, graphics, zoom,
			world, boxShape, boxBody, planeBody, planeShape;
			var heightfieldBody;
		
		var heightMap = generateHeightMap(123, 200);
		init();
		animate();
		
		function generateHeightMap(seed, size) {
			var r = new Random(seed);
			var arr = Array(size);
			for(var i=0;i<size;i++) {
				if(i < 5)
					arr[i] = 0;
				else if(i < size / 4)
					arr[i] = (r.next() % 3);
				else if(i < size / 2)
					arr[i] = (r.next() % 6);
				else
					arr[i] = (r.next() % 10);
			}
			return arr;
		}
		
		function init(){
			// Init p2.js
			world = new p2.World();
			// Add a box
			boxShape = new p2.Box({ width: 2, height: 1 });
			// boxShape.collisionGroup = 2;
			// boxShape.collisionMask = 1;
			boxBody = new p2.Body({
				mass:1,
				position:[0,20],
				angularVelocity:1
			});
			boxBody.addShape(boxShape);
			world.addBody(boxBody);
			// Add a plane
			// planeShape = new p2.Plane();
			// planeBody = new p2.Body({ position:[0,-1] });
			// planeBody.addShape(planeShape);
			// world.addBody(planeBody);
			// Pixi.js zoom level
			zoom = 15;
			// Initialize the stage
			renderer =	PIXI.autoDetectRenderer(600, 400),
			// stage = new PIXI.Stage(0xFFFFFF);
			// We use a container inside the stage for all our content
			// This enables us to zoom and translate the content
			// container = new PIXI.DisplayObjectContainer(),
			container = new PIXI.Container(),
			// stage.addChild(container);
			// Add the canvas to the DOM
			document.body.appendChild(renderer.view);
			// Add transform to the container
			container.position.x =	renderer.width/2; // center at origin
			container.position.y =	renderer.height/2;
			container.scale.x =	 zoom;	// zoom in
			container.scale.y = -zoom; // Note: we flip the y axis to make "up" the physics "up"
			// Draw the box.
			graphics = new PIXI.Graphics();
			graphics.beginFill(0xff0000);
			graphics.drawRect(-boxShape.width/2, -boxShape.height/2, boxShape.width, boxShape.height);
			// Add the box to our container
			container.addChild(graphics);
			
			//add height map
			const step = 5;
			var heightfieldShape = new p2.Heightfield({
				heights: heightMap,
				elementWidth: step, // Distance between the data points in X direction
				angle: Math.PI / 2
			});
			// heightfieldShape.collisionGroup = 1;
			// heightfieldShape.collisionMask = 2;
			
			heightfieldBody = new p2.Body({position:[-15,0], mass: 0});
			heightfieldBody.addShape(heightfieldShape);
			world.addBody(heightfieldBody);
			
			var ground = new PIXI.Graphics();
			const lineWidth = 0.1;
			ground.lineStyle(lineWidth, 0x00ff00, 1);
			// ground.beginFill(0x00ff00, 1);
			ground.moveTo(-15*step, 0);
			for(var i=0;i<heightMap.length;i++){
				ground.lineTo(i*step-15*step, heightMap[i] - 1);
			}
			container.addChild(ground)
		}
		// Animation loop
		function animate(t){
			t = t || 0;
			requestAnimationFrame(animate);
			// Move physics bodies forward in time
			world.step(1/60);
			// Transfer positions of the physics objects to Pixi.js
			graphics.position.x = boxBody.position[0];
			graphics.position.y = boxBody.position[1];
			graphics.rotation = boxBody.angle;
			// Render scene
			// renderer.render(stage);
			renderer.render(container);
		}
	</script>
</body>
</html>